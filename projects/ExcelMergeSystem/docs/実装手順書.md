# Excel結合処理システム 実装手順書

**文書情報**

- 作成日：2026年1月7日
- バージョン：2.0
- 文書種別：実装手順書（セットアップガイド）

---

## 1. 概要

本手順書では、Excel結合処理システムのセットアップから動作確認までの手順を説明します。

---

## 2. 事前要件

### 2.1 システム要件

- **OS**: Windows 10 / 11
- **Excel**: Microsoft Excel 2016 以降（64bit版推奨）
- **マクロ設定**: マクロ実行が有効であること

### 2.2 確認事項

1. Excelのバージョン確認
   - **ファイル → アカウント → Excelのバージョン情報**
   - 32bit/64bit の確認

2. マクロセキュリティ設定
   - **ファイル → オプション → トラストセンター → トラストセンターの設定**
   - 「警告を表示してすべてのマクロを無効にする」以上

---

## 3. セットアップ手順

### 3.1 フォルダ構成の確認

以下のフォルダ構成になっていることを確認:

```
ファイル結合システム/
├── src/
│   ├── UTF-8/        ← 編集用ソースコード
│   └── Shift_JIS/    ← VBAインポート用
├── batch/
│   └── Start.bat     ← 起動用バッチ
├── docs/             ← ドキュメント
├── Config/           ← 設定ファイル格納（要作成）
├── Output/           ← 出力ファイル格納（自動作成）
├── Logs/             ← ログファイル格納（自動作成）
└── README.md
```

### 3.2 ExcelMergeEngine.xlsm の作成

#### Step 1: 新規マクロ有効ブックの作成

1. Excelを起動
2. 空のブックを作成
3. **ファイル → 名前を付けて保存**
4. ファイルの種類: **Excel マクロ有効ブック (*.xlsm)**
5. ファイル名: `ExcelMergeEngine.xlsm`
6. 保存場所: `ファイル結合システム/` フォルダ直下

#### Step 2: VBAエディタを開く

- **Alt + F11** キーを押す
- または **開発 → Visual Basic**

> **Note**: 開発タブが表示されていない場合
>
> - ファイル → オプション → リボンのユーザー設定
> - 「開発」にチェックを入れる

#### Step 3: 参照設定

1. VBAエディタで **ツール → 参照設定**
2. 以下にチェック:
   - ☑ Microsoft Excel 16.0 Object Library（通常はデフォルトで有効）
   - ☑ **Microsoft Scripting Runtime**（重要！）
3. OKをクリック

#### Step 4: モジュールのインポート

1. VBAエディタで **ファイル → ファイルのインポート**
2. `src/Shift_JIS/` フォルダを開く
3. 以下の順序でインポート:

   | 順番 | ファイル名 | 説明 |
   |:----:|------------|------|
   | 1 | modConstants.bas | 定数定義（先にインポート必須） |
   | 2 | modLogger.bas | ログ処理 |
   | 3 | modConfig.bas | 設定管理 |
   | 4 | modValidator.bas | 検証処理 |
   | 5 | modFileHandler.bas | ファイル処理 |
   | 6 | modDataProcessor.bas | データ処理 |
   | 7 | modMain.bas | メイン処理 |

#### Step 5: ThisWorkbook への設定

1. プロジェクトエクスプローラーで **ThisWorkbook** をダブルクリック
2. `src/Shift_JIS/ThisWorkbook.cls` の内容をコピー
3. ThisWorkbook のコードエリアに貼り付け

#### Step 6: 保存

- **Ctrl + S** で保存
- VBAエディタを閉じる

### 3.3 設定ファイルの作成

#### Step 1: Config フォルダの作成

`ファイル結合システム/Config/` フォルダを作成

#### Step 2: MergeConfig.xlsx の作成

1. 新規Excelファイルを作成
2. シート名を **Config** に変更
3. 以下の内容をA1セルから入力:

| A列（設定項目） | B列（値） | C列（説明） |
|----------------|-----------|-------------|
| 設定項目 | 値 | 説明 |
| Excel1_HeaderRows | 3 | Excel1のヘッダー行数 |
| Excel1_DataStartRow | 4 | Excel1のデータ開始行 |
| Excel1_IDColumn | B | Excel1の識別コード列 |
| Excel2_HeaderRows | 2 | Excel2のヘッダー行数 |
| Excel2_DataStartRow | 3 | Excel2のデータ開始行 |
| Excel2_IDColumn | A | Excel2の識別コード列 |
| Output_FileNameFormat | 結合データ_[DATE].xlsx | 出力ファイル名形式 |
| Output_IncludeLogSheet | TRUE | ログシート含む |

1. `Config/MergeConfig.xlsx` として保存

---

## 4. 動作確認

### 4.1 テストデータの準備

#### テストデータ1: TestData_Excel1.xlsx

3行ヘッダー + B列が識別コード:

| A | B | C | D |
|---|---|---|---|
| 顧客マスタ | | | |
| | | | |
| 番号 | 顧客コード | 顧客名 | 住所 |
| 1 | C001 | 田中商店 | 東京都 |
| 2 | C002 | 鈴木工業 | 大阪府 |
| 3 | C003 | 佐藤物産 | 愛知県 |

#### テストデータ2: TestData_Excel2.xlsx

2行ヘッダー + A列が識別コード:

| A | B | C |
|---|---|---|
| 売上データ | | |
| 顧客コード | 売上金額 | 売上日 |
| C001 | 100000 | 2026/01/01 |
| C002 | 200000 | 2026/01/02 |
| C004 | 150000 | 2026/01/03 |

### 4.2 実行テスト

1. TestData_Excel1.xlsx と TestData_Excel2.xlsx を準備
2. 両方のファイルを選択（Ctrl + クリック）
3. `batch/Start.bat` にドラッグ＆ドロップ
4. 処理完了を待つ
5. `Output/` フォルダを確認

### 4.3 結果確認

出力ファイルに以下が含まれていることを確認:

- **結合データシート**: マージされたデータ
- **処理ログシート**: 統計情報とログ

期待される結合結果:

| 共通データ | C001, C002 |
| Excel1のみ | C003 |
| Excel2のみ | C004 |

---

## 5. トラブルシューティング

### 5.1 よくあるエラーと対処

| エラー | 原因 | 対処 |
|--------|------|------|
| 「マクロが無効です」 | セキュリティ設定 | マクロを有効にする |
| 「参照エラー」 | Microsoft Scripting Runtime 未設定 | 参照設定を確認 |
| 「ファイルが見つかりません」 | パスの問題 | 日本語や特殊文字を含まないパスを使用 |
| 「コンパイルエラー」 | インポート順序の問題 | modConstants を最初にインポート |

### 5.2 デバッグ方法

1. VBAエディタを開く（Alt + F11）
2. イミディエイトウィンドウを表示（Ctrl + G）
3. ログメッセージを確認
4. 必要に応じてブレークポイントを設定（F9）
5. ステップ実行（F8）

---

## 6. カスタマイズ

### 6.1 識別コード列の変更

`MergeConfig.xlsx` の以下を変更:

```
Excel1_IDColumn = C    ← C列に変更
Excel2_IDColumn = B    ← B列に変更
```

### 6.2 ヘッダー行数の変更

```
Excel1_HeaderRows = 5  ← 5行ヘッダーに変更
Excel2_HeaderRows = 1  ← 1行ヘッダーに変更
```

### 6.3 出力ファイル名の変更

```
Output_FileNameFormat = 月次レポート_[DATE].xlsx
```

`[DATE]` は `yyyymmdd_hhmmss` 形式の日時に置換されます。

---

## 7. 改訂履歴

| 版数 | 日付 | 内容 | 作成者 |
|------|------|------|--------|
| 2.0 | 2026/01/07 | v2.0対応、モジュール分離対応 | - |
| 1.0 | 2025/07/16 | 初版作成 | - |
