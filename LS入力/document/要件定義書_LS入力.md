# LS入力システム 要件定義書

最終更新: 2025-08-30 / 作成: JJ-07

## 1. 概要
本システムは、Outlookの予定をExcelに取得し、業務区分に応じて日々の実績を入力・集計して「月次データ」へ転記する業務支援マクロ群（VBA）で構成する。主目的は、予定の転記・集計の省力化と記入ミス削減、集計軸（作業コード×作番）の柔軟な拡張である。

## 2. 対象範囲（スコープ）
- 対象ブック: `LS入力.xlsm`（本番）
- 対象シート: 「データ取得」「データ登録」「月次データ」
- 対象マクロ:
  - Outlook予定取得: `GetOutlookSchedule`, `ExecuteOutlookSchedule`（`ModGetOutlookSch`）
  - 転記・集計: `TransferDataToMonthlySheet`（`ModDataTransfer`）
  - 入力クリア: `ClearInputData`（`ModDataClear`）
  - 月次メンテ（全クリア＋カレンダー更新）: `ClearMonthlyDataAndRefreshCalendar`（`ModMonthlyMaintenance`）
  - 行クリア（ダブルクリック）: `Worksheet_BeforeDoubleClick`（`ダブルクリック削除r1.cls`）

スコープ外: 外部DB連携、クラウドOutlook API連携、複数ユーザー同時編集制御、印刷レイアウト最適化。

## 3. 利用者・関係者
- 利用者: 日々の実績入力・月次集計を行う担当者
- 管理者: シート保護・列追加ポリシー設定・マスタ（キー行列）の保守担当
- IT管理: マクロの署名、Outlook参照設定、配布・バージョン管理

## 4. 用語定義
- 作番: 作業単位（案件・チケット等）を識別する番号
- 作業コード: 作業種別（例: 設計、開発、会議 など）
- キー行列（KeyMatrix）: 件名から「クラス」や「区分」を判定するキーワードの一覧
- クラス/区分: 予定件名から自動推定される分類（任意運用）。

## 5. システム全体フロー（要約）
1) データ取得: 「データ取得」シートに対象日を入力し、Outlook予定を一覧化（必要に応じて自動分類）。
2) データ登録: 「データ登録」シートに、作番・作業コード・作業時間を入力（時間は複数形式を許容）。
3) 転記: 入力内容を日付別×（作業コード×作番）で集計し、「月次データ」に転記。必要に応じて列を自動追加。
4) 保守: 月次領域の全クリア、カレンダー日付の再セット、入力領域のクリアを提供。

---

## 6. 機能要件

### 6.1 Outlook予定取得（ModGetOutlookSch）
- 入力: 「データ取得」`C3` の日付（シリアル値/日付文字列対応）。
- 取得対象: 対象日の 00:00〜23:59 に開始または終了がかかる予定（繰り返し含む）。
- 出力: 「データ取得」行7をヘッダー、行8以降に一覧化（開始時刻昇順）。
  - 列構成（既定・コード準拠）
    - C列: 時間 `HHMM-HHMM`（例: 1300-1430）
    - D列: 件名（Subject）
    - E列: 会議時間（所要）`HHMM` 文字列
    - F列: クラス（KeyMatrixに基づく自動判定、任意）
    - G列: 予備（未使用）
    - H列: 区分（KeyMatrix_区分に基づく自動判定、任意）
- 自動分類: 以下のブック内名前定義の組で判定する。
  - `KeyMatrix`（n×m）と `ClassList`（n×1）: 件名→クラス
  - `KeyMatrix_区分`（n×m）と `ClassList_区分`（n×1）: 件名→区分
  - 判定は行単位のOR条件（同一行にいずれか含まれれば一致）。
- 振る舞い: 実行時に対象行の既存データをクリア、ヘッダーを整備、0件時はメッセージ表示。
- 付帯: 「データ取得」`C4` の日付を「データ登録」`D4` にコピー（存在時）。
- エラー処理: シート名不正・日付不正・Outlook接続不可・その他例外をメッセージ表示。保護中は一時解除して処理後に復元。

### 6.2 データ登録（入力仕様）
- 対象: 「データ登録」シート、8行目以降。
- 入力列（既定）
  - C列: 作番（文字列）
  - D列: 作業コード（文字列）
  - E列: 作業時間（許容形式: `H:MM`、`HHMM`、Excel時間シリアル、数値分）
- 日付セル: `D4`（優先）→空のとき `D3` を使用。
- 入力クリア（`ClearInputData`）
  - 「データ取得」`C8:F22` と `H8:H22` をクリア、`C4`・「データ登録」`E24` の補助セルも対象。
  - 「データ登録」側の一部補助列（例: `F8:F22`）をクリア（作業時間入力列は転記対象のためクリアしない）。
  - シート保護が有効な場合はパスワード確認のうえ一時解除・復元。

### 6.3 転記・集計（ModDataTransfer）
- 入力: 「データ登録」から対象日（`D4` 優先→`D3`）、C〜E列の行データ。
- 変換: 作業時間は多様な表記から分（整数）へ正規化。
- 集計キー: `作業コード|作番` 単位で分を合算。
- 転記先: 「月次データ」
  - 日付列: B列。対象日の一致行を検索して書き込み行（targetRow）とする。
  - 列構成: C列以降に「作番行」「作業コード行」の2段ヘッダー（典型: 作番=10行、作業コード=11行）。
  - 列マッピング: 既存列のヘッダー（作業コード×作番）を解析し、辞書にマップ。
  - 列未存在時: 列追加ポリシーに従い、新規列を作成（既定=ユーザー確認）。
    - 新規列は既存列の幅・配置・色等を踏襲し、データ範囲の表示形式 `[hh]:mm` を付与。
- 重複処理: 書き込みセルに既存値がある場合は「上書き」し、
  - 月次シート `I1` に重複検知ログを追記、該当セルをハイライト（既定=黄色）。
- 結果表示: 転記完了メッセージ（件数、重複数、新規列数、その他メモ）をダイアログ表示。
- 付帯: 集計サマリーをタブ区切りでクリップボードへ出力する補助機能を提供。
- 保護: 処理中は月次シート保護を一時解除し、`UserInterfaceOnly:=True` で復元。

### 6.4 月次メンテ（ModMonthlyMaintenance）
- 「月次データ」の転記領域（C列以降、データ行全体）を一括クリア（値・塗りつぶし）。
- 対象月のカレンダー（日付列B）を再生成（1日〜末日）。実行前にYes/No確認。
- エラーは月次シートのエラーセル（例: `I1`）に追記。

### 6.5 行クリア（ダブルクリック：ダブルクリック削除r1.cls）
- 対象: 対象シートのB列セルをダブルクリックすると、その行の入力領域をクリア。
- 既定クリア範囲: 行のC列から右方向に4列（C〜F）、およびH列を追加でクリア。
- シート保護パスワードが設定されている場合は、処理前に一時解除・復元。

### 6.6 エラー処理・ログ
- ダイアログ: 致命的エラーはメッセージボックスで通知（原因別メッセージ）。
- シートログ: 「月次データ」`I1` にエラー/重複/注意喚起を追記し折り返し表示。

---

## 7. 非機能要件
- 実行環境: Windows 10 以降、Microsoft Excel 2016 以降（デスクトップ版, VBA）、Microsoft Outlook（デスクトップ版, MAPI）。
- 参照設定: Outlook Object Library 有効化（遅延バインディング運用でも可）。
- 性能目標: 1日分の予定取得≤5秒、月次転記≤3秒（100行・100列程度）。
- 保守性: シート名・セル番地・色などは定数で集中管理。列追加はポリシーで制御（確認/自動/拒否）。
- セキュリティ: マクロ有効ブック、信頼済みロケーションでの運用を前提。シート保護は`UserInterfaceOnly`で復元。

## 8. データ・レイアウト要件
- 「データ取得」
  - 入力: `C3`（日付）。補助: `C4`（取得日コピー用）。
  - 一覧: ヘッダー=7行、データ=8行〜。列=C:時間, D:件名, E:会議時間(HHMM), F:クラス, G:予備, H:区分。
- 「データ登録」
  - 日付セル: `D4`（優先）/`D3`（代替）
  - 入力: 8行〜、C:作番, D:作業コード, E:作業時間。
  - 補助セル: `E24`（残業等の補助項目・任意運用）。
- 「月次データ」
  - 日付列: B列。カレンダーは対象月の全日を連続行で保持。
  - 列ヘッダー: 2段（例: 10行=作番、11行=作業コード）。データ開始行はヘッダー直下。
  - 新規列: 既存列の書式（幅・配置・色・折返し）を継承。
- ブック内名前定義（必須）
  - `KeyMatrix`, `ClassList`（件名→クラス）
  - `KeyMatrix_区分`, `ClassList_区分`（件名→区分）

## 9. 操作手順（標準）
1) 「データ取得」`C3` に日付入力 → 予定取得を実行。
2) 必要に応じて「クラス」「区分」を見直し。
3) 「データ登録」に対象日の `D4` を確認し、C〜E列へ実績を入力。
4) 転記ボタン（`TransferDataToMonthlySheet`）を実行 → プレビューで確認 → 実行。
5) 必要に応じて「月次メンテ」（全クリア/カレンダー更新）や「入力クリア」を実行。

## 10. 入力バリデーション
- 日付: `C3`/`D4`/`D3` は有効な日付に限定（未入力・不正形式は実行不可）。
- 時間: `E` 列は `H:MM` / `HHMM` / シリアル / 分数を許容。不正値はエラー。
- 予定取得: Outlook未起動時は起動を試行。接続不可・フォルダ未取得はエラー。

## 11. 受け入れ基準（抜粋）
- 予定取得が対象日の全予定（単発/繰返し）を時刻順に出力する。
- 件名に応じたクラス/区分の自動判定がキー行列通りに行われる。
- 転記時に、同一（作業コード×作番）は同日内で合算される。
- 月次シートに該当列が無い場合、ポリシーに応じて列が追加され、書式が継承される。
- 既存値があるセルに書き込む場合は上書きされ、I1に重複記録・対象セルがハイライトされる。
- 月次メンテが値・塗りつぶしの全クリア、対象月の日付再生成を正しく行う。

## 12. 前提・制約
- Excel/Outlook はデスクトップ版（MAPI）を前提。Exchange/365環境の制限に依存。
- マクロ有効設定・信頼済フォルダ・署名（必要時）を整備。
- シート名・セル番地はコード定数と一致させる（名称変更時はコード更新が必要）。

## 13. 運用・保守
- 列追加ポリシー: 既定は「確認」。自動/拒否は運用ポリシーに従い切替。
- キー行列メンテ: 追加・変更は名前定義の範囲を更新（行追加時は`ClassList`整合）。
- エラー/重複ログ: 「月次データ」`I1` を定期クリア。異常時はスクリーンショット保全。

## 14. 移行・導入
- 配布: 署名済み`xlsm`を配布。Outlook参照設定は遅延バインドでも動作（推奨: 参照設定有効化）。
- バージョン: `document/` に変更履歴・評価を保管（既存: `作成したマクロの評価.md`）。

## 15. 未確定・要確認事項
- 月次シートのヘッダー行番号（作番/作業コード）とデータ開始行の正規定義。
- 「データ登録」シートの補助列（F列等）の正式用途とクリア対象範囲。
- 列追加ポリシーの本番既定（確認/自動/拒否）。
- 予定取得一覧の最大行数・範囲（8〜22行で十分か、拡張要否）。
- クリップボード出力の運用（貼り付け先テンプレート有無）。

## 16. 参考（実装上の主な定数・名前）
- シート名: 「データ取得」「データ登録」「月次データ」
- 主なセル: `C3`（取得日）/ `C4`（取得日コピー）/ `D3`,`D4`（転記日）/ `I1`（メッセージ）
- 取得一覧: ヘッダー行=7、データ開始=8、列=C..H
- 月次: 日付列=B、データ列=C以降、ヘッダー2段（作番/作業コード）
- 名前定義: `KeyMatrix`, `ClassList`, `KeyMatrix_区分`, `ClassList_区分`

