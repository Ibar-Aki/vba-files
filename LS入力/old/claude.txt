'================================================================================
' 機能: 「データ登録」→「月次データ」へ転記（区分＋作番で列特定）
' 改訂: v2.3 - 改善版
'================================================================================
Option Explicit

'=========================
' 定数定義の改善
'=========================
' シート名
Private Const DATA_SHEET_NAME As String = "データ登録"
Private Const ACQUISITION_SHEET_NAME As String = "データ取得"
Private Const MONTHLY_SHEET_NAME As String = "月次データ"

' セル位置
Private Const DATE_CELL_PRIORITY As String = "D4"
Private Const DATE_CELL_NORMAL As String = "D3"

' 行・列番号
Private Const DATA_START_ROW As Long = 8
Private Const MONTHLY_WORKNO_ROW As Long = 8
Private Const MONTHLY_HEADER_ROW As Long = 9
Private Const MONTHLY_DATA_START_ROW As Long = 10
Private Const MONTHLY_MIN_COL As Long = 3  ' 月次データの開始列（C列）

' 列識別子
Private Const DATE_COL As String = "B"
Private Const MESSAGE_COL As String = "A"
Private Const WORK_NO_COL As String = "C"    ' 作番列
Private Const CATEGORY_COL As String = "D"   ' 区分列
Private Const TIME_COL As String = "E"       ' 時間列

' データ範囲
Private Const CLEAR_RANGE_ACQ As String = "C8:E22"
Private Const CLEAR_RANGE_DATA As String = "F8:F17"

' その他の定数
Private Const MINUTES_PER_HOUR As Double = 60#
Private Const MINUTES_PER_DAY As Double = 1440#
Private Const MAX_MINUTES_PER_HOUR As Long = 60
Private Const MAX_RETRY_CLIPBOARD As Long = 5
Private Const DEFAULT_PREVIEW_ROWS As Long = 31

' 文字列定数
Private Const KEY_SEPARATOR As String = "|"
Private Const MESSAGE_SEPARATOR As String = vbLf
Private Const TIME_FORMAT As String = "[h]:mm"
Private Const DATE_FORMAT As String = "yyyy/mm/dd"

' 列追加ポリシー（Enumの代替）
Private Const AddPolicy_Prompt As Long = 0
Private Const AddPolicy_Auto As Long = 1
Private Const AddPolicy_Reject As Long = 2

' 動作設定
Private Const AUTO_ADD_POLICY As Long = AddPolicy_Prompt
Private Const ACCUMULATE_MODE As Boolean = True
Private Const DRY_RUN As Boolean = False
Private Const DUP_HIGHLIGHT_COLOR As Long = vbYellow

'=========================
' データ構造の定義
'=========================
' 時間データ項目
Private Type TimeDataItem
    WorkNo As String
    Category As String
    Minutes As Double
    IsValid As Boolean
End Type

' 転記設定
Private Type TransferConfig
    TargetDate As Date
    TargetRow As Long
    AccumulateMode As Boolean
    DryRun As Boolean
    AddPolicy As Long
End Type

' 処理結果
Private Type ProcessResult
    ProcessedCount As Long
    DuplicateCount As Long
    ErrorCount As Long
    Messages As String
End Type

'=========================
' カスタムエラー定数
'=========================
Private Const ERR_SHEET_NOT_FOUND As Long = vbObjectError + 1
Private Const ERR_INVALID_DATE As Long = vbObjectError + 2
Private Const ERR_NO_DATA As Long = vbObjectError + 3
Private Const ERR_DATE_NOT_FOUND As Long = vbObjectError + 4
Private Const ERR_PROTECTION_FAILED As Long = vbObjectError + 5

'=========================
' エラーハンドリング改善
'=========================
Private Sub RaiseCustomError(ByVal errorCode As Long, ByVal description As String)
    Err.Raise errorCode, "TransferDataModule", description
End Sub

Private Function GetErrorDetails(ByVal errNum As Long, ByVal errDesc As String) As String
    Select Case errNum
        Case ERR_SHEET_NOT_FOUND
            GetErrorDetails = "必要なシートが見つかりません: " & errDesc
        Case ERR_INVALID_DATE
            GetErrorDetails = "日付が無効です: " & errDesc
        Case ERR_NO_DATA
            GetErrorDetails = "転記するデータがありません: " & errDesc
        Case ERR_DATE_NOT_FOUND
            GetErrorDetails = "対象日付が月次シートに見つかりません: " & errDesc
        Case ERR_PROTECTION_FAILED
            GetErrorDetails = "シート保護の解除に失敗しました: " & errDesc
        Case 9 ' Subscript out of range
            GetErrorDetails = FriendlyErrorMessage(errNum, errDesc)
        Case Else
            GetErrorDetails = "予期しないエラーが発生しました (Error #" & errNum & "): " & errDesc
    End Select
End Function

'=========================
' メイン処理（改善版）
'=========================
Public Sub TransferDataToMonthlySheet()
    Dim prevState As ApplicationState
    Dim config As TransferConfig
    Dim result As ProcessResult
    
    ' アプリケーション状態の保存と設定
    SaveAndSetApplicationState prevState
    
    On Error GoTo ErrorHandler
    
    ' 初期化と検証
    If Not InitializeTransferConfig(config) Then GoTo CleanUp
    
    ' データ処理
    ProcessTimeDataTransfer config, result
    
    ' 結果表示
    ShowTransferResults result
    
CleanUp:
    RestoreApplicationState prevState
    Exit Sub
    
ErrorHandler:
    Dim errorMsg As String
    errorMsg = GetErrorDetails(Err.Number, Err.Description)
    MsgBox errorMsg, vbCritical, "転記エラー"
    Resume CleanUp
End Sub

'=========================
' アプリケーション状態管理
'=========================
Private Type ApplicationState
    ScreenUpdating As Boolean
    EnableEvents As Boolean
    Calculation As XlCalculation
End Type

Private Sub SaveAndSetApplicationState(ByRef prevState As ApplicationState)
    With prevState
        .ScreenUpdating = Application.ScreenUpdating
        .EnableEvents = Application.EnableEvents
        .Calculation = Application.Calculation
    End With
    
    With Application
        .ScreenUpdating = False
        .EnableEvents = False
        .Calculation = xlCalculationManual
    End With
End Sub

'=========================
' 初期化と設定
'=========================
Private Function InitializeTransferConfig(ByRef config As TransferConfig) As Boolean
    Dim wsData As Worksheet, wsMonthly As Worksheet
    
    ' シートの取得
    If Not GetRequiredWorksheets(wsData, wsMonthly) Then
        InitializeTransferConfig = False
        Exit Function
    End If
    
    ' 日付の決定
    If Not DetermineTargetDate(wsData, config.TargetDate) Then
        InitializeTransferConfig = False
        Exit Function
    End If
    
    ' その他の設定
    config.AccumulateMode = ACCUMULATE_MODE
    config.DryRun = DRY_RUN
    config.AddPolicy = AUTO_ADD_POLICY
    
    ' 対象行の取得
    config.TargetRow = FindMatchingDateRowDyn(wsMonthly, config.TargetDate)
    If config.TargetRow = 0 Then
        RaiseCustomError ERR_DATE_NOT_FOUND, Format$(config.TargetDate, DATE_FORMAT)
        InitializeTransferConfig = False
        Exit Function
    End If
    
    InitializeTransferConfig = True
End Function

Private Function GetRequiredWorksheets(ByRef wsData As Worksheet, ByRef wsMonthly As Worksheet) As Boolean
    On Error GoTo SheetError
    
    Set wsData = ThisWorkbook.Sheets(DATA_SHEET_NAME)
    Set wsMonthly = ThisWorkbook.Sheets(MONTHLY_SHEET_NAME)
    
    GetRequiredWorksheets = True
    Exit Function
    
SheetError:
    RaiseCustomError ERR_SHEET_NOT_FOUND, "必要なシート: " & DATA_SHEET_NAME & ", " & MONTHLY_SHEET_NAME
    GetRequiredWorksheets = False
End Function

Private Function DetermineTargetDate(ByRef wsData As Worksheet, ByRef targetDate As Date) As Boolean
    If IsDate(wsData.Range(DATE_CELL_PRIORITY).Value) Then
        targetDate = CDate(wsData.Range(DATE_CELL_PRIORITY).Value)
    ElseIf IsDate(wsData.Range(DATE_CELL_NORMAL).Value) Then
        targetDate = CDate(wsData.Range(DATE_CELL_NORMAL).Value)
    Else
        RaiseCustomError ERR_INVALID_DATE, "登録日（" & DATE_CELL_NORMAL & "）または任意日付（" & DATE_CELL_PRIORITY & "）"
        DetermineTargetDate = False
        Exit Function
    End If
    
    DetermineTargetDate = True
End Function

Private Sub RestoreApplicationState(ByRef prevState As ApplicationState)
    With Application
        .Calculation = prevState.Calculation
        .EnableEvents = prevState.EnableEvents
        .ScreenUpdating = prevState.ScreenUpdating
    End With
End Sub